# Elasticsearch

## 前言

### es是什么, 有什么特点

简单点说就是一个**实时**搜索引擎，提供一个**分布式**的高性能全文搜索引擎，基于RESTful接口。

es使用java语言开发，底层是基于Apache Lucene。

使用**索引倒排**，通过**关键字**定位文档数据。

### es与mongodb的区别

* 相同点
    * 以json方式管理数据的nosql数据库。
    * 支持crud、全文检索、数据分片等操作。
    * 不支持完整的事务操作，只支持阉割版的事务。
    * 适合处理超大规模的数据。
* 不同点
    * es是java编写，通过RESTful接口操作数据。mongodb是C++编写，通过数据库驱动操作。
    * mongodb分片有hash和range方式，但是es只有hash。
    * es天生就是分布式的，支持主备分片的自动分配和复制。mongodb的分布式是由`前置查询路由+配置服务+shard集合`管理，需要手动配置，可以理解为类似mycat的基于代理的方式。
    * es采用倒排索引，mongodb底层是B+树。
    * es所有字段自动索引，mongodb的字段需要手动索引。
    * es非实时有数据丢失窗口。mongodb实时理论上无数据丢失风险。

es更偏向于实时检索、数据分析，而mongodb更适合大量数据的crud。两者都只能使用在对事务要求不强的场景下。

## 倒排索引

常规的正向索引，指的就是不同id的数据对应不同的记录，即`id--data`。

倒排索引顾名思义，是反过来的，我们通过data中的关键字对应多个可能的data，即`关键字1--data1,data2,data3`、`关键字2--data3`。

下面举个简单的例子：

数据信息

|ID| 文章内容     |
|--|--|
|1| 小米手机     |
|2| 小米家具     |
|3| 一部小米手机 |
|4| 一部华为手机 |
|5| 小米手表     |

关键字对应数据信息

| 关键字 | 数据信息   |
| ------ | ---------- |
| 小米   | 1、2、3、5 |
| 手机   | 1、3、4    |

## 节点角色

### master主节点

主节点的主要职责是负责集群层面的相关操作，管理集群变更，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。

主节点也可以作为数据节点，但稳定的主节点对集群的健康是非常重要的，默认情况下任何一个集群中的节点都有可能被选为主节点，索引数据和搜索查询等操作会占用大量的cpu，[内存](https://so.csdn.net/so/search?q=内存&spm=1001.2101.3001.7020)，io资源，为了确保一个集群的稳定，分离主节点和数据节点是一个比较好的选择。

通过配置node.master:true(默认)使节点具有被选举为Master的资格。主节点使全局唯一的，将从有资格成为Master的节点中选举。

为了放置数据丢失，每个主节点应该知道有资格成为主节点的数量，默认为1，为了避免网络分区出现多主的情况，配置discovery.zen.minimun_master_nodes原则上最小值应该为：(master_eligible_nodes/2)+1。

```
node.master:true
    
node.data:false
```

### data数据节点

　数据节点主要是存储索引数据的节点，执行数据相关操作：CRUD、搜索，聚合操作等。数据节点对cpu，内存，I/O要求较高， 在优化的时候需要监控数据节点的状态，当资源不够的时候，需要在集群中添加新的节点。

通过配置node.data:true(默认来是一个节点成为数据节点)，也可以通过下面配置创建一个数据节点:

```
node.master:false

node.data:true

node.ingest:false
```

### master-eligible候选节点

和主节点的配置相同，在选举时可以被选举为主节点。

### voting投票节点

设置为仅投票节点后即使配置了data.master = true，也不会参选，但是仍然可以作为数据节点。
```
# 是否为投票节点
Node.voting_only = true
```

### coordinating协调者节点

客户端请求可以发送到集群的任何节点，每个节点都知道任意文档所处的位置，然后转发这些请求，收集数据并返回给客户端，处理客户端请求的节点称为协调节点。

协调节点将请求转发给保存数据的数据节点。每个数据节点在本地执行请求，并将结果返回给协调节点。协调节点收集完数据后，将每个数据节点的结果合并为单个全局结果。对结果收集和排序的过程可能需要很多CPU和内存资源。

通过下面配置创建一个仅用于协调的节点：

```
node.master:false

node.data:false

node.ingest:false
```

### ingest抽取(过滤)节点

ingest 节点可以看作是数据前置处理转换的节点，支持 pipeline管道 设置，可以使用 ingest 对数据进行过滤、转换等操作，类似于 logstash 中 filter 的作用，功能相当强大。

Ingest节点的功能可以抽象为：大数据处理环节的“ETL”——抽取、转换、加载。

### MachineLearing机器学习节点

略
