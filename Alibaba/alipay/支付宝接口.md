# 支付宝接口

## SDK有两个

```xml
<!-- 这个是老SDK功能完善, 稳定, 文档中有些还是使用老版本SDK演示 -->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-sdk-java</artifactId>
    <version>4.19.4.ALL</version>
</dependency>

<!-- 这个是新SDK, 使用简单, 链式调用, 基本稳定 -->
<dependency>
    <groupId>com.alipay.sdk</groupId>
    <artifactId>alipay-easysdk</artifactId>
    <version>2.2.1</version>
</dependency>
```

## 配置

```java
@Configuration
public class AlipayConfig {

    public static final String APP_ID = "隐藏";

    public static final String APP_PRIVATE_KEY = "隐藏";

    public static final String ALIPAY_PUBLIC_KEY = "隐藏";

    public static final String SIGN_TYPE = "隐藏";

    // 老版SDK配置
    @Bean
    public AlipayClient alipayClient() {
        return new DefaultAlipayClient("https://openapi.alipaydev.com/gateway.do",
                APP_ID,
                APP_PRIVATE_KEY,
                "json",
                "utf-8",
                ALIPAY_PUBLIC_KEY,
                SIGN_TYPE);
    }

    // 新版SDK配置
    @Bean
    public Config alipayEasySdkConfig() {
        Config config = new Config();
        config.appId = APP_ID;
        config.merchantPrivateKey = APP_PRIVATE_KEY;
        config.alipayPublicKey = ALIPAY_PUBLIC_KEY;
        config.signType = SIGN_TYPE;
        Factory.setOptions(config);
        return config;
    }
}
```

## 接口测试

```java
@RestController
@RequiredArgsConstructor
@CrossOrigin
public class MainController {

    private final AlipayClient alipayClient;

    // 支付完成后跳转的URL
    private static final String ALIPAY_RETURN_URL = "http://101.34.176.170:8080/hello";

    // 支付成功后通知该URl
    private static final String ALIPAY_NOTIFY_URL = "http://101.34.176.170:8080/notify";

    // 电脑网页
    @GetMapping("testPc")
    public void testPc(HttpServletResponse resp) throws Exception {
        String form = Factory.Payment.Page()
                .asyncNotify(ALIPAY_NOTIFY_URL)
                .pay("显康君",
                        UUID.randomUUID().toString(),
                        String.format("%.2f", Math.random() * 9000 + 100),
                        ALIPAY_RETURN_URL).getBody();
        System.out.println(form);
        form = form.replaceFirst("null", "https");
        form = form.replaceFirst("null", "openapi.alipaydev.com");

        resp.setContentType("text/html;charset=utf-8");
        resp.getWriter().write(form);
    }

    // 手机网页
    @GetMapping("testMobile")
    public void testMobile(HttpServletResponse resp) throws Exception {
        String form = Factory.Payment.Wap()
                .asyncNotify(ALIPAY_NOTIFY_URL)
                .pay("显康君",
                        UUID.randomUUID().toString(),
                        String.format("%.2f", Math.random() * 9000 + 100),
                        ALIPAY_RETURN_URL, ALIPAY_RETURN_URL)
                .getBody();
        System.out.println(form);
        form = form.replaceFirst("null", "https");
        form = form.replaceFirst("null", "openapi.alipaydev.com");

        resp.setContentType("text/html;charset=utf-8");
        resp.getWriter().write(form);
    }

    @GetMapping("hello")
    public String hello() {
        return "hello";
    }

    // 通知接口
    @PostMapping("notify")
    public void notifyUrl(HttpServletRequest req) throws AlipayApiException {
        // 存放支付信息, 包括鉴权信息
        Map<String, String[]> paramMap = req.getParameterMap();
        HashMap<String, String> map = new HashMap<>();
        paramMap.forEach((key, value) -> {
            System.out.println(key);
            System.out.println(Arrays.toString(value));
            System.out.println("-------------------------------");
        });
        // 订单id
        map.put("trade_no", Arrays.stream(paramMap.get("trade_no")).findFirst().orElse(null));
        // 订单状态
        map.put("trade_status", Arrays.stream(paramMap.get("trade_status")).findFirst().orElse(null));
        // 总价格
        map.put("total_amount", Arrays.stream(paramMap.get("total_amount")).findFirst().orElse(null));
        // 鉴权算法类型
        map.put("sign_type", Arrays.stream(paramMap.get("sign_type")).findFirst().orElse(null));
        System.out.println(map);
        System.out.println(AlipayConfig.ALIPAY_PUBLIC_KEY);
        // !---: 2021/11/19 在沙箱环境下会出问题, 只能签约支付宝线上测试
        final boolean signVerified =
                AlipaySignature.rsaCheckV1(map,
                        AlipayConfig.ALIPAY_PUBLIC_KEY, "utf-8");
        if (signVerified) {
            System.out.println("是支付宝连接");
        } else {
            System.out.println("不是支付宝连接");
        }
    }
}
```

