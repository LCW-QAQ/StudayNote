# 位运算技巧

## 获取二进制位最右边的1

```python
num = 12
last_one = num & (-num)
```

>众所周知计算机存储的是补码, 负数的补码是`取反 +1`, 正数的补码不变, 无论正负数符号位不变
>
>为了方便下面都是以1个字节(8bit)为例, 不是常见的int 4字节(32位)
>
>12 补码应该是 `0000 1100`
>
>~12 = `1111 0011`
>
>~12 + 1 = `1111 0100`
>
>~12 + 1就是12的负数形式即`-12`
>
>12 & -12 表示为:
>
>​	`0000 1100` 12
>
>​	`1111 0100` -12
>
>=  `0000 0100`
>
>我们就的到了最右边的1
>
>
>取反一个数就是把0变1, 1变0, 那么a & ~a 的结果就一定是0, 他们每一位都不一样
>
>从低到高一直到第一个1, 位置上原本是0, 取反后是1, 而第一个1就变成了0, 表示为`0000 1000` => `0000 0111`
>
>取反后在+1就巧妙的又获得了最右边的1, 同时这个1的左右两边与原本的数全部相反, 因此 a & -a 自然就可以得到最右边的1了

## 获取某一个二进制位具体是二进制的第几位

```python
# 例如现在获取了最右边的1, 我们想知道它具体是第几位
num = 12
last_one = num & -num
# java 提供了Integer.bitCount(int num), 用于获取有几个1
# Integer.bitCount(lastOne - 1)即可获取它是二进制的第几位
index = bin(last_one).count("0") - 1
```

python是直接通过字符串的方式获取, java提供的Integer.bitCount更加复杂, 底层通过位运算实现

TODO: 2022/1/11 有时间在单独折腾, Integer.bitCount的源码

## 关于二进制第i位的常见运算

> i从0开始

### 将第i位设置为1

```python
num = 12
i = 1
print(bin(num))  # 0b1100
num |= 1 << i
print(bin(num))  # 0b1110
```

### 将第i位设置为0

```python
num = 12
i = 2
print(bin(num))  # 0b1100
num &= ~(1 << i)
print(bin(num))  # 0b1000
```

### 将第i位翻转

```python
num = 12
i = 1
print(bin(num))  # 0b1100
num ^= 1 << i
print(bin(num))  # 0b1110
```

### 判断第i位是0 or 1

```python
def exist(num: int, i: int) -> bool:
    """判断指定数字第i + 1位是否是1
    """
    # ((num >> i) & 1) == 0   0表示第i + 1二进制位为0反之为1
    # (num & (1 << i)) == 0   0表示第i + 1二进制位为0, 若!=0表示i + 1二进制位为1
    # 两种方式都可以
    return bool(num & (1 << i))


num = 12
print(bin(num))  # 0b1100
print(exist(num, 1))
print(exist(num, 2))
```

### Java BitSet

```java
public class Main {
    public static void main(String[] args) {
        BitSet set = new BitSet();
        // 设置[0, 8)为false, 即0, 默认所有位都是0
        set.set(0, 8, false);
        System.out.println(set);
        // 将4位设置为1
        set.set(4);
        System.out.println(set);
        // 将6位设置为1
        set.set(6);
        System.out.println(set);
        // 将0位翻转
        set.flip(0);
        System.out.println(set);
        // 将7位设置为1
        set.set(7);
        System.out.println(set);
        // 将7位设置为0
        set.set(7, false);
        System.out.println(set);
    }
}
```

## 使用&运算代替%运算

对于`a % b`这个操作，当b是2的n次幂时，有`a & (b - 1) == a % b`
